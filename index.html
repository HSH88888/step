<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinite Stairs - Photo Match</title>
    <style>
        @font-face {
            font-family: 'DungGeunMo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
            font-weight: normal; font-style: normal;
        }

        body {
            margin: 0; padding: 0; 
            background-color: #333;
            font-family: 'DungGeunMo', monospace;
            width: 100vw; height: 100vh;
            overflow: hidden; touch-action: manipulation;
            user-select: none; -webkit-user-select: none;
        }

        #game-container {
            position: relative; width: 100%; height: 100%;
            background-color: #2c3e50;
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 10;
        }
        .pointer-auto { pointer-events: auto; }
        .hidden { display: none !important; }

        /* Î°úÎπÑ ÌôîÎ©¥ */
        .lobby-screen {
            background-color: #bce0ff; z-index: 100;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .lobby-header {
            width: 100%; padding: 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .leaderboard-btn {
            background: rgba(255,215,0,0.9); padding: 8px 15px; border-radius: 4px;
            border: 2px solid #000; color: #000; font-size: 14px;
            cursor: pointer; box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            font-family: 'DungGeunMo', monospace;
        }
        .leaderboard-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        
        .currency-group {
            display: flex; gap: 10px;
        }
        
        .currency-pill {
            background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 4px;
            color: #fff; font-size: 14px; display: flex; align-items: center; gap: 5px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }

        .game-logo {
            margin-top: 20px; text-align: center;
            transform: rotate(-3deg);
            animation: floatLogo 3s infinite ease-in-out;
        }
        @keyframes floatLogo { 0%,100%{transform:rotate(-3deg) translateY(0);} 50%{transform:rotate(-3deg) translateY(-10px);} }
        
        .logo-text {
            font-size: 70px; color: #ffce00;
            -webkit-text-stroke: 4px #0044cc;
            text-shadow: 5px 5px 0 #000;
            line-height: 1.1;
        }

        /* Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï ÏòÅÏó≠ */
        .custom-area {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; gap: 15px;
            width: 100%;
        }

        .preview-canvas {
            width: 150px; height: 150px;
            border: 4px solid #000;
            border-radius: 10px;
            background: rgba(255,255,255,0.5);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            image-rendering: pixelated;
        }

        .selector-box {
            background: rgba(255,255,255,0.8);
            border: 4px solid #000; border-radius: 10px;
            padding: 10px; width: 80%; max-width: 400px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .selector-label { font-size: 14px; color: #555; margin-bottom: 5px; }
        .selector-row {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 10px;
        }
        .arrow-btn {
            background: #ff5e57; border: 2px solid #000; color: white;
            width: 40px; height: 40px; font-size: 20px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 2px 2px 0 #000;
        }
        .arrow-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        .selection-name { font-size: 20px; font-weight: bold; color: #333; min-width: 100px; text-align: center; }

        .lobby-footer {
            width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.2), transparent);
        }

        .start-btn {
            width: 100%; padding: 15px;
            background: #ff9f43; border: 4px solid #000;
            font-size: 36px; color: #fff;
            text-shadow: 3px 3px 0 #000; cursor: pointer;
            box-shadow: 6px 6px 0 #c65f12; transition: transform 0.1s;
        }
        .start-btn:active { transform: translate(4px, 4px); box-shadow: 2px 2px 0 #c65f12; }

        /* Ïù∏Í≤åÏûÑ HUD */
        .hud-area {
            width: 100%; padding: 15px; box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }

        .home-btn {
            position: absolute; top: 15px; left: 15px;
            width: 50px; height: 50px; background: #fff;
            border: 3px solid #000; border-radius: 10px;
            font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 3px 3px 0 #000; pointer-events: auto;
        }
        .home-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        .timer-frame {
            width: 100%; max-width: 400px; height: 16px;
            background: #333; border: 3px solid #000;
            margin-bottom: 5px; position: relative; margin-top: 10px;
        }
        .timer-fill {
            width: 100%; height: 100%; background: #00ff00;
            transition: width 0.1s linear;
        }

        .info-row { display: flex; gap: 15px; align-items: flex-end; text-shadow: 2px 2px 0 #000; }
        .level-text { font-size: 24px; color: #ffd700; animation: pulse 2s infinite; }
        .score-text { font-size: 40px; color: #fff; }
        .coin-text { font-size: 24px; color: #ffd700; }

        /* Ïª®Ìä∏Î°§ Î≤ÑÌäº */
        .controls-area {
            display: flex; justify-content: center; gap: 30px;
            padding-bottom: 40px; pointer-events: auto;
        }
        .control-btn {
            width: 110px; height: 110px; border-radius: 20px;
            border: 4px solid #000;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; background: #fff;
        }
        .control-btn:active { transform: translate(4px, 4px); box-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
        .btn-turn { background: #ff5e57; }
        .btn-climb { background: #4bcffa; }
        .btn-icon { font-size: 36px; color: #fff; text-shadow: 2px 2px 0 #000; margin-bottom: 5px; }
        .btn-label { font-size: 16px; color: #fff; text-shadow: 2px 2px 0 #000; }

        /* Í≤åÏûÑ Ïò§Î≤Ñ ÌôîÎ©¥ */
        .gameover-screen {
            background-color: rgba(33, 45, 59, 0.95);
            z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .gameover-title {
            font-size: 60px;
            color: #ff4d4d;
            text-shadow: 6px 6px 0 #b32400;
            font-family: 'DungGeunMo', monospace;
            margin-bottom: 40px;
            letter-spacing: 2px;
        }

        .gameover-stats {
            text-align: center;
            font-size: 24px;
            color: #ffffff;
            text-shadow: 2px 2px 0 #000;
            line-height: 1.6;
            margin-bottom: 40px;
        }
        .stat-value { color: #ffd700; }

        .retry-btn {
            background: #ffffff;
            border: 4px solid #000;
            padding: 15px 70px;
            font-family: 'DungGeunMo', monospace;
            font-size: 30px;
            color: #000;
            cursor: pointer;
            box-shadow: 10px 10px 0 #000;
            transition: transform 0.1s;
        }
        .retry-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 6px 6px 0 #000;
        }
        
        /* Ïù¥Î¶Ñ ÏûÖÎ†• Î™®Îã¨ */
        .name-input-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 6px solid #000;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
            z-index: 300;
            text-align: center;
            max-width: 90%;
            width: 350px;
        }
        
        .modal-title {
            font-size: 28px;
            color: #ff9f43;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 10px;
        }
        
        .modal-subtitle {
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
        }
        
        .name-input {
            width: 100%;
            padding: 12px;
            font-size: 20px;
            font-family: 'DungGeunMo', monospace;
            border: 3px solid #000;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .submit-name-btn {
            width: 100%;
            padding: 12px;
            background: #4bcffa;
            border: 3px solid #000;
            font-size: 24px;
            font-family: 'DungGeunMo', monospace;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            cursor: pointer;
            box-shadow: 4px 4px 0 #000;
        }
        .submit-name-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        
        /* ÏàúÏúÑÌëú ÌôîÎ©¥ */
        .leaderboard-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 250;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .leaderboard-header {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .leaderboard-title {
            font-size: 48px;
            color: #ffd700;
            text-shadow: 4px 4px 0 #000;
        }
        
        .close-leaderboard-btn {
            width: 50px;
            height: 50px;
            background: #ff5e57;
            border: 3px solid #000;
            border-radius: 10px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 3px 3px 0 #000;
        }
        .close-leaderboard-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }
        
        .leaderboard-list {
            width: 100%;
            max-width: 600px;
            background: rgba(255,255,255,0.95);
            border: 5px solid #000;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.3);
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 3px solid #ddd;
            transition: background 0.2s;
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-item.new-record {
            background: #fff9c4;
            animation: highlight 1s ease-in-out infinite;
        }
        
        @keyframes highlight {
            0%, 100% { background: #fff9c4; }
            50% { background: #ffeb3b; }
        }
        
        .rank-badge {
            font-size: 28px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        
        .rank-1 { color: #ffd700; text-shadow: 2px 2px 0 #000; }
        .rank-2 { color: #c0c0c0; text-shadow: 2px 2px 0 #000; }
        .rank-3 { color: #cd7f32; text-shadow: 2px 2px 0 #000; }
        .rank-other { color: #666; }
        
        .player-info {
            flex: 1;
            padding: 0 15px;
        }
        
        .player-name {
            font-size: 20px;
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .player-details {
            font-size: 14px;
            color: #666;
        }
        
        .player-score {
            font-size: 32px;
            color: #ff9f43;
            font-weight: bold;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }
        
        .empty-leaderboard {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }
        
        @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- Î°úÎπÑ ÌôîÎ©¥ -->
    <div id="lobbyUI" class="ui-layer lobby-screen pointer-auto">
        <div class="lobby-header">
            <button class="leaderboard-btn" onclick="showLeaderboard()">üèÜ ÏàúÏúÑÌëú</button>
            <div class="currency-group">
                <div class="currency-pill">üí∞ <span id="totalCoins">0</span></div>
                <div class="currency-pill">üíé <span id="totalGems">50</span></div>
            </div>
        </div>

        <div class="game-logo">
            <div class="logo-text">Î¨¥ÌïúÏùò<br>Í≥ÑÎã®</div>
        </div>

        <div class="custom-area">
            <div class="selector-box">
                <div class="selector-label">Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</div>
                <canvas id="charPreview" class="preview-canvas" width="150" height="150"></canvas>
                <div class="selector-row">
                    <button class="arrow-btn" onclick="changeCharacter(-1)">‚óÄ</button>
                    <div class="selection-name" id="charNameDisplay">ÌöåÏÇ¨Ïõê</div>
                    <button class="arrow-btn" onclick="changeCharacter(1)">‚ñ∂</button>
                </div>
            </div>

            <div class="selector-box">
                <div class="selector-label">Î∞∞Í≤Ω ÏÑ†ÌÉù</div>
                <canvas id="bgPreview" class="preview-canvas" width="150" height="150"></canvas>
                <div class="selector-row">
                    <button class="arrow-btn" onclick="changeBackground(-1)">‚óÄ</button>
                    <div class="selection-name" id="bgNameDisplay">ÎèÑÏãú ÏïºÍ≤Ω</div>
                    <button class="arrow-btn" onclick="changeBackground(1)">‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="lobby-footer">
            <button class="start-btn" onclick="startGame()">Í≤åÏûÑ ÏãúÏûë</button>
        </div>
    </div>

    <!-- Ïù∏Í≤åÏûÑ UI -->
    <div id="gameUI" class="ui-layer hidden">
        <div class="hud-area">
            <button class="home-btn" onclick="goToLobby()">üè†</button>

            <div class="timer-frame">
                <div class="timer-fill" id="timerBar"></div>
            </div>
            <div class="info-row">
                <div class="level-text">LV.<span id="levelDisplay">1</span></div>
                <div class="score-text" id="scoreDisplay">0</div>
                <div class="coin-text">üí∞<span id="gameCoins">0</span></div>
            </div>
        </div>

        <div class="controls-area">
            <button class="control-btn btn-turn" ontouchstart="handleInput('TURN')" onmousedown="handleInput('TURN')">
                <div class="btn-icon">‚Ü∫</div>
                <div class="btn-label">Î∞©Ìñ•Ï†ÑÌôò</div>
            </button>
            <button class="control-btn btn-climb" ontouchstart="handleInput('CLIMB')" onmousedown="handleInput('CLIMB')">
                <div class="btn-icon">‚áó</div>
                <div class="btn-label">Ïò§Î•¥Í∏∞</div>
            </button>
        </div>
    </div>

    <!-- Í≤åÏûÑ Ïò§Î≤Ñ ÌôîÎ©¥ -->
    <div id="gameOverUI" class="ui-layer gameover-screen hidden pointer-auto">
        <div class="gameover-title">TIME OVER</div>
        
        <div class="gameover-stats">
            <div>SCORE: <span class="stat-value" id="finalScore">0</span></div>
            <div>LEVEL: <span class="stat-value" id="finalLevel">1</span></div>
            <div>COINS: <span class="stat-value" id="finalCoins">0</span></div>
        </div>
        
        <button class="retry-btn" onclick="startGame()">RETRY</button>
        
        <button class="home-btn" style="position: static; margin-top: 30px; width: 50px; height: 50px;" onclick="goToLobby()">üè†</button>
    </div>

    <!-- Ïù¥Î¶Ñ ÏûÖÎ†• Î™®Îã¨ -->
    <div id="nameInputModal" class="name-input-modal hidden pointer-auto">
        <div class="modal-title">üéâ Ïã†Í∏∞Î°ù!</div>
        <div class="modal-subtitle">
            <span id="rankPosition">10</span>Îì± Îã¨ÏÑ±!<br>
            Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî
        </div>
        <input type="text" id="playerNameInput" class="name-input" maxlength="10" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†• (ÏµúÎåÄ 10Ïûê)">
        <button class="submit-name-btn" onclick="submitName()">Îì±Î°ù</button>
    </div>

    <!-- ÏàúÏúÑÌëú ÌôîÎ©¥ -->
    <div id="leaderboardUI" class="ui-layer leaderboard-screen hidden pointer-auto">
        <div class="leaderboard-header">
            <div class="leaderboard-title">üèÜ ÏàúÏúÑÌëú</div>
            <button class="close-leaderboard-btn" onclick="closeLeaderboard()">‚úï</button>
        </div>
        
        <div class="leaderboard-list" id="leaderboardList">
            <div class="empty-leaderboard">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>
        </div>
    </div>
</div>

<script>
    'use strict';
    
    // ==========================================
    // Îç∞Ïù¥ÌÑ∞ Î∞è ÏÑ§Ï†ï
    // ==========================================
    const CONFIG = {
        STAIR: { WIDTH: 100, HEIGHT: 50, VISIBLE: 25 },
        PLAYER: { SCALE: 2.5, SPEED: 0.4 },
        LEVEL: { STEPS: 100, START_TIME: 120, TIME_DEC: 2, MIN_TIME: 15, REFILL: 5 },
        COIN: { CHANCE: 0.3, VALUE: 10 }
    };

    const CHARACTERS = [
        { id: 'MAN', name: 'ÌöåÏÇ¨Ïõê' },
        { id: 'RABBIT', name: 'ÌÜ†ÎÅº' },
        { id: 'DOG', name: 'Í∞ïÏïÑÏßÄ' }
    ];

    const BACKGROUNDS = [
        { id: 'NIGHT', name: 'ÎèÑÏãú ÏïºÍ≤Ω', top: '#0f0c29', bot: '#302b63' },
        { id: 'DAY', name: 'ÎßëÏùÄ ÎÇÆ', top: '#2980b9', bot: '#6dd5fa' },
        { id: 'SUNSET', name: 'ÎÖ∏ÏùÑ', top: '#ff512f', bot: '#dd2476' }
    ];

    // ==========================================
    // Î≥ÄÏàò
    // ==========================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let state = {
        status: 'LOBBY',
        score: 0,
        level: 1,
        timeMax: 60,
        timeCur: 100,
        charIdx: 0, 
        bgIdx: 0,
        sessionCoins: 0,
        totalCoins: 0,
        lastRecordId: null
    };

    let player = { gX: 0, gY: 0, vX: 0, vY: 0, dir: -1, jumpY: 0 };
    let camera = { x: 0, y: 0 };
    let stairs = [];
    let coins = [];
    let bgObjects = [];

    // ==========================================
    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ - ÏàúÏúÑÌëú
    // ==========================================
    function loadLeaderboard() {
        const saved = localStorage.getItem('infiniteStairsLeaderboard');
        return saved ? JSON.parse(saved) : [];
    }

    function saveLeaderboard(leaderboard) {
        localStorage.setItem('infiniteStairsLeaderboard', JSON.stringify(leaderboard));
    }

    function checkNewRecord(score, level, coins) {
        const leaderboard = loadLeaderboard();
        
        // 10Îì± ÏïàÏóê ÎìúÎäîÏßÄ ÌôïÏù∏
        if (leaderboard.length < 10) {
            return true; // 10Í∞ú ÎØ∏ÎßåÏù¥Î©¥ Î¨¥Ï°∞Í±¥ Îì±Î°ù Í∞ÄÎä•
        }
        
        const lowestScore = leaderboard[leaderboard.length - 1].score;
        return score > lowestScore;
    }

    function getRankPosition(score) {
        const leaderboard = loadLeaderboard();
        let rank = 1;
        
        for (let record of leaderboard) {
            if (score <= record.score) {
                rank++;
            }
        }
        
        return rank;
    }

    function addToLeaderboard(name, score, level, coins) {
        const leaderboard = loadLeaderboard();
        const date = new Date().toISOString().split('T')[0];
        const id = Date.now();
        
        leaderboard.push({
            id: id,
            name: name || 'Î¨¥Î™Ö',
            score: score,
            level: level,
            coins: coins,
            date: date
        });
        
        // Ï†êÏàò ÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÎÇ¥Î¶ºÏ∞®Ïàú)
        leaderboard.sort((a, b) => b.score - a.score);
        
        // ÏÉÅÏúÑ 10Í∞úÎßå Ïú†ÏßÄ
        const top10 = leaderboard.slice(0, 10);
        saveLeaderboard(top10);
        
        return id;
    }

    function displayLeaderboard(highlightId = null) {
        const leaderboard = loadLeaderboard();
        const listContainer = document.getElementById('leaderboardList');
        
        if (leaderboard.length === 0) {
            listContainer.innerHTML = '<div class="empty-leaderboard">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
            return;
        }
        
        let html = '';
        leaderboard.forEach((record, index) => {
            const rank = index + 1;
            const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
            const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
            const isNew = record.id === highlightId ? 'new-record' : '';
            
            html += `
                <div class="leaderboard-item ${isNew}">
                    <div class="rank-badge ${rankClass}">${medal}</div>
                    <div class="player-info">
                        <div class="player-name">${record.name}</div>
                        <div class="player-details">LV.${record.level} ‚Ä¢ ${record.date}</div>
                    </div>
                    <div class="player-score">${record.score}</div>
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
    }

    // ==========================================
    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ - ÏΩîÏù∏
    // ==========================================
    function loadSavedData() {
        const saved = localStorage.getItem('infiniteStairsCoins');
        if (saved) {
            state.totalCoins = parseInt(saved) || 0;
        }
        updateCoinDisplay();
    }

    function saveTotalCoins() {
        localStorage.setItem('infiniteStairsCoins', state.totalCoins);
        updateCoinDisplay();
    }

    function updateCoinDisplay() {
        document.getElementById('totalCoins').innerText = state.totalCoins;
    }

    // ==========================================
    // UI Ï†úÏñ¥
    // ==========================================
    window.showLeaderboard = function() {
        document.getElementById('leaderboardUI').classList.remove('hidden');
        displayLeaderboard();
    };

    window.closeLeaderboard = function() {
        document.getElementById('leaderboardUI').classList.add('hidden');
    };

    function showNameInputModal(rank) {
        document.getElementById('rankPosition').innerText = rank;
        document.getElementById('playerNameInput').value = '';
        document.getElementById('nameInputModal').classList.remove('hidden');
        document.getElementById('playerNameInput').focus();
    }

    window.submitName = function() {
        const name = document.getElementById('playerNameInput').value.trim() || 'Î¨¥Î™Ö';
        const recordId = addToLeaderboard(name, state.score, state.level, state.sessionCoins);
        state.lastRecordId = recordId;
        
        document.getElementById('nameInputModal').classList.add('hidden');
        
        // ÏàúÏúÑÌëúÎ°ú ÏûêÎèô Ïù¥Îèô
        setTimeout(() => {
            showLeaderboard();
            displayLeaderboard(recordId);
        }, 300);
    };

    // ÏóîÌÑ∞ÌÇ§Î°ú Ïù¥Î¶Ñ Ï†úÏ∂ú
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Enter' && !document.getElementById('nameInputModal').classList.contains('hidden')) {
            submitName();
        }
    });

    // ==========================================
    // Ï¥àÍ∏∞Ìôî Î∞è Ïù¥Î≤§Ìä∏
    // ==========================================
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        generateBackgroundObjects();
        if(state.status === 'LOBBY') {
            drawLobbyCanvas();
            updateCharacterPreview();
            updateBackgroundPreview();
        } else if(state.status === 'GAMEOVER') drawGameCanvas();
    }
    window.addEventListener('resize', resize);
    
    function goToLobby() {
        state.status = 'LOBBY';
        document.getElementById('gameUI').classList.add('hidden');
        document.getElementById('gameOverUI').classList.add('hidden');
        document.getElementById('nameInputModal').classList.add('hidden');
        document.getElementById('leaderboardUI').classList.add('hidden');
        document.getElementById('lobbyUI').classList.remove('hidden');
        
        generateBackgroundObjects();
        drawLobbyCanvas();
        updateCharacterPreview();
        updateBackgroundPreview();
    }

    window.changeCharacter = function(dir) {
        state.charIdx += dir;
        if(state.charIdx < 0) state.charIdx = CHARACTERS.length - 1;
        if(state.charIdx >= CHARACTERS.length) state.charIdx = 0;
        document.getElementById('charNameDisplay').innerText = CHARACTERS[state.charIdx].name;
        updateCharacterPreview();
    };

    window.changeBackground = function(dir) {
        state.bgIdx += dir;
        if(state.bgIdx < 0) state.bgIdx = BACKGROUNDS.length - 1;
        if(state.bgIdx >= BACKGROUNDS.length) state.bgIdx = 0;
        document.getElementById('bgNameDisplay').innerText = BACKGROUNDS[state.bgIdx].name;
        generateBackgroundObjects();
        drawLobbyCanvas();
        updateBackgroundPreview();
    };

    function startGame() {
        state.status = 'PLAYING';
        state.score = 0;
        state.level = 1;
        state.timeCur = 100;
        state.sessionCoins = 0;
        state.lastRecordId = null;
        updateDifficulty();

        document.getElementById('lobbyUI').classList.add('hidden');
        document.getElementById('gameOverUI').classList.add('hidden');
        document.getElementById('nameInputModal').classList.add('hidden');
        document.getElementById('leaderboardUI').classList.add('hidden');
        document.getElementById('gameUI').classList.remove('hidden');

        initGameData();
        updateUI();
        animate();
    }

    function initGameData() {
        player.gX = 0; player.gY = 0;
        player.vX = 0; player.vY = 0;
        player.dir = -1;
        camera.x = 0; camera.y = 0;
        stairs = [{x: 0, y: 0, color: '#fff', hasCoin: false}];
        coins = [];
        
        for(let i=1; i<=6; i++) stairs.push({x: -i, y: -i, color: getRandomColor(), hasCoin: false});
        for(let i=0; i<40; i++) addRandomStair();
    }

    function updateDifficulty() {
        let t = CONFIG.LEVEL.START_TIME - (state.level - 1) * CONFIG.LEVEL.TIME_DEC;
        state.timeMax = Math.max(CONFIG.LEVEL.MIN_TIME, t);
    }

    function getRandomColor() {
        const c = ['#ff9ff3', '#feca57', '#ff6b6b', '#48dbfb', '#1dd1a1', '#ffffff'];
        return c[Math.floor(Math.random() * c.length)];
    }

    function addRandomStair() {
        const last = stairs[stairs.length - 1];
        const prev = stairs[stairs.length - 2];
        let dir = last.x - prev.x;
        if (Math.random() < 0.5) dir = -dir;
        
        const hasCoin = Math.random() < CONFIG.COIN.CHANCE;
        stairs.push({ x: last.x + dir, y: last.y - 1, color: getRandomColor(), hasCoin: hasCoin });
        
        if(hasCoin) {
            coins.push({
                x: (last.x + dir) * CONFIG.STAIR.WIDTH,
                y: (last.y - 1) * CONFIG.STAIR.HEIGHT,
                stairIdx: stairs.length - 1,
                collected: false
            });
        }
    }

    function generateBackgroundObjects() {
        bgObjects = [];
        const width = window.innerWidth;
        const height = window.innerHeight;
        const type = BACKGROUNDS[state.bgIdx].id;

        if (type === 'NIGHT') {
            let x = 0;
            while(x < width) {
                const w = 50 + Math.random() * 80;
                const h = 100 + Math.random() * 300;
                let wins = [];
                for(let wy=height-h+20; wy<height-20; wy+=20) {
                    for(let wx=x+10; wx<x+w-10; wx+=15) {
                        if(Math.random()>0.3) wins.push({x:wx, y:wy});
                    }
                }
                bgObjects.push({type:'BUILDING', x:x, y:height-h, w:w, h:h, color: '#1a2530', wins:wins});
                x += w;
            }
        } else {
            for(let i=0; i<10; i++) {
                bgObjects.push({
                    type: 'CLOUD',
                    x: Math.random() * width,
                    y: Math.random() * (height/2),
                    size: 30 + Math.random() * 50,
                    speed: 0.2 + Math.random() * 0.5
                });
            }
            if(type === 'SUNSET') {
                bgObjects.push({ type:'SUN', x: width/2, y: height/2 + 100, size: 150 });
            }
        }
    }

    // ==========================================
    // ÌîÑÎ¶¨Î∑∞ ÏóÖÎç∞Ïù¥Ìä∏
    // ==========================================
    function updateCharacterPreview() {
        const preview = document.getElementById('charPreview');
        const pctx = preview.getContext('2d');
        pctx.clearRect(0, 0, 150, 150);
        
        pctx.save();
        pctx.translate(75, 100);
        pctx.scale(3, 3);
        drawPlayerShape(pctx, CHARACTERS[state.charIdx].id, true);
        pctx.restore();
    }

    function updateBackgroundPreview() {
        const preview = document.getElementById('bgPreview');
        const pctx = preview.getContext('2d');
        
        const bg = BACKGROUNDS[state.bgIdx];
        const grad = pctx.createLinearGradient(0, 0, 0, 150);
        grad.addColorStop(0, bg.top);
        grad.addColorStop(1, bg.bot);
        pctx.fillStyle = grad;
        pctx.fillRect(0, 0, 150, 150);
        
        if(bg.id === 'NIGHT') {
            pctx.fillStyle = '#1a2530';
            pctx.fillRect(10, 80, 30, 70);
            pctx.fillRect(50, 60, 40, 90);
            pctx.fillRect(100, 90, 35, 60);
            pctx.fillStyle = '#f9c74f';
            for(let y=90; y<140; y+=10) {
                for(let x=15; x<35; x+=10) {
                    if(Math.random()>0.3) pctx.fillRect(x, y, 3, 4);
                }
            }
        } else if(bg.id === 'SUNSET') {
            pctx.fillStyle = '#ffd700';
            pctx.beginPath();
            pctx.arc(75, 75, 30, 0, Math.PI*2);
            pctx.fill();
        }
        
        pctx.fillStyle = 'rgba(255,255,255,0.6)';
        pctx.beginPath();
        pctx.arc(30, 30, 15, 0, Math.PI*2);
        pctx.fill();
        pctx.beginPath();
        pctx.arc(110, 50, 20, 0, Math.PI*2);
        pctx.fill();
    }

    // ==========================================
    // Í≤åÏûÑ Î°úÏßÅ
    // ==========================================
    window.handleInput = function(action) {
        if (state.status !== 'PLAYING') return;
        if (event && event.cancelable) event.preventDefault();

        const next = stairs[state.score + 1];
        const curr = stairs[state.score];
        const reqDir = next.x < curr.x ? -1 : 1;
        let success = false;

        if (action === 'CLIMB' && player.dir === reqDir) success = true;
        if (action === 'TURN') {
            const newDir = player.dir * -1;
            player.dir = newDir;
            if (newDir === reqDir) success = true;
        }

        if (success) {
            player.gX += player.dir;
            player.gY -= 1;
            state.score++;
            
            const currentStair = stairs[state.score];
            if(currentStair.hasCoin) {
                const coin = coins.find(c => c.stairIdx === state.score && !c.collected);
                if(coin) {
                    coin.collected = true;
                    state.sessionCoins += CONFIG.COIN.VALUE;
                    state.totalCoins += CONFIG.COIN.VALUE;
                    saveTotalCoins();
                }
            }
            
            state.timeCur = Math.min(100, state.timeCur + CONFIG.LEVEL.REFILL);
            player.jumpY = 20;
            addRandomStair();
            if (state.score > 0 && state.score % CONFIG.LEVEL.STEPS === 0) levelUp();
            updateUI();
        } else {
            player.gX += player.dir;
            gameOver();
        }
    };

    function levelUp() {
        state.level++;
        updateDifficulty();
    }

    function gameOver() {
        state.status = 'GAMEOVER';
        document.getElementById('finalScore').innerText = state.score;
        document.getElementById('finalLevel').innerText = state.level;
        document.getElementById('finalCoins').innerText = state.sessionCoins;
        document.getElementById('gameOverUI').classList.remove('hidden');
        
        // Ïã†Í∏∞Î°ù Ï≤¥ÌÅ¨
        if (checkNewRecord(state.score, state.level, state.sessionCoins)) {
            const rank = getRankPosition(state.score);
            setTimeout(() => {
                showNameInputModal(rank);
            }, 1000);
        }
    }

    document.addEventListener('keydown', (e) => {
        if (state.status === 'PLAYING') {
            if (e.code === 'KeyZ' || e.code === 'ArrowLeft') handleInput('TURN');
            if (e.code === 'KeyX' || e.code === 'ArrowRight') handleInput('CLIMB');
        } else if (state.status === 'LOBBY' || state.status === 'GAMEOVER') {
            if (e.code === 'Space' || e.code === 'Enter') {
                const modal = document.getElementById('nameInputModal');
                if (modal.classList.contains('hidden')) {
                    startGame();
                }
            }
        }
    });

    function updateUI() {
        document.getElementById('scoreDisplay').innerText = state.score;
        document.getElementById('levelDisplay').innerText = state.level;
        document.getElementById('gameCoins').innerText = state.sessionCoins;
    }

    // ==========================================
    // Î†åÎçîÎßÅ
    // ==========================================
    function animate() {
        if (state.status === 'LOBBY') {
            drawLobbyCanvas();
            requestAnimationFrame(animate);
            return;
        }
        
        updatePhysics();
        drawGameCanvas();
        
        if (state.status === 'PLAYING' || state.status === 'GAMEOVER') {
            requestAnimationFrame(animate);
        }
    }

    function updatePhysics() {
        if (state.status === 'PLAYING') {
            const drain = 100 / (state.timeMax * 60);
            state.timeCur -= drain;
            if (state.timeCur <= 0) gameOver();

            const bar = document.getElementById('timerBar');
            bar.style.width = Math.max(0, state.timeCur) + "%";
            if(state.timeCur < 30) bar.style.background = '#ff0000';
            else bar.style.background = '#00ff00';

            const tx = player.gX * CONFIG.STAIR.WIDTH;
            const ty = player.gY * CONFIG.STAIR.HEIGHT;
            player.vX += (tx - player.vX) * CONFIG.PLAYER.SPEED;
            player.vY += (ty - player.vY) * CONFIG.PLAYER.SPEED;
            if(player.jumpY > 0) player.jumpY -= 2;

            camera.x += (player.vX - camera.x) * CONFIG.PLAYER.SPEED;
            camera.y += (player.vY - camera.y) * CONFIG.PLAYER.SPEED;
        } else if (state.status === 'GAMEOVER') {
            player.vX += (player.gX * CONFIG.STAIR.WIDTH - player.vX) * 0.1;
            player.vY += 25;
        }
    }

    function drawBackground(offsetY) {
        const bg = BACKGROUNDS[state.bgIdx];
        const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grad.addColorStop(0, bg.top);
        grad.addColorStop(1, bg.bot);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(0, offsetY);

        if (bg.id === 'NIGHT') {
            for(let b of bgObjects) {
                ctx.fillStyle = b.color;
                ctx.fillRect(b.x, b.y, b.w, b.h + 1000);
                ctx.fillStyle = '#f9c74f';
                for(let w of b.wins) ctx.fillRect(w.x, w.y, 6, 8);
            }
        } else {
            if(bg.id === 'SUNSET') {
                const sun = bgObjects.find(o=>o.type==='SUN');
                if(sun) {
                    ctx.fillStyle = '#ffd700';
                    ctx.beginPath(); ctx.arc(sun.x, sun.y, sun.size, 0, Math.PI*2); ctx.fill();
                }
            }
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            for(let c of bgObjects) {
                if(c.type === 'CLOUD') {
                    c.x += c.speed;
                    if(c.x > canvas.width + 50) c.x = -50;
                    ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, Math.PI*2); ctx.fill();
                }
            }
        }
        ctx.restore();
    }

    function drawLobbyCanvas() {
        drawBackground(0);
        
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2 + 50);
        ctx.scale(2, 2);
        
        const bounce = Math.sin(Date.now() / 200) * 10;
        drawPlayer(0, -bounce - 50, true);
        ctx.restore();
    }

    function drawGameCanvas() {
        drawBackground(camera.y * 0.2);

        ctx.save();
        const cx = canvas.width / 2;
        const cy = canvas.height * 0.7;
        ctx.translate(cx - camera.x, cy - camera.y);

        const start = Math.max(0, state.score - 15);
        const end = Math.min(stairs.length, state.score + CONFIG.STAIR.VISIBLE);

        for (let i = start; i < end; i++) {
            const s = stairs[i];
            const sx = s.x * CONFIG.STAIR.WIDTH;
            const sy = s.y * CONFIG.STAIR.HEIGHT;
            drawStair(sx, sy, s.color, i === state.score);
            
            if(s.hasCoin) {
                const coin = coins.find(c => c.stairIdx === i);
                if(coin && !coin.collected) {
                    const rotation = Date.now() / 200;
                    ctx.save();
                    ctx.translate(sx, sy - 20);
                    ctx.rotate(rotation);
                    ctx.fillStyle = '#ffd700';
                    ctx.fillRect(-8, -8, 16, 16);
                    ctx.fillStyle = '#ffed4e';
                    ctx.fillRect(-6, -6, 12, 12);
                    ctx.restore();
                }
            }
        }

        drawPlayer(player.vX, player.vY - player.jumpY, false);
        ctx.restore();
    }

    function drawStair(x, y, color, isCurrent) {
        const w = CONFIG.STAIR.WIDTH;
        const h = CONFIG.STAIR.HEIGHT;
        ctx.fillStyle = isCurrent ? '#fff' : color;
        ctx.fillRect(x - w/2, y, w, h);
        ctx.lineWidth = 4; ctx.strokeStyle = '#000';
        ctx.strokeRect(x - w/2, y, w, h);
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fillRect(x - w/2, y + h, w, 20);
    }

    function drawPlayer(x, y, isLobby) {
        const sc = CONFIG.PLAYER.SCALE;
        const charType = CHARACTERS[state.charIdx].id;

        ctx.save();
        ctx.translate(x, y);
        ctx.scale(sc, sc);
        if (!isLobby && player.dir === 1) ctx.scale(-1, 1);

        drawPlayerShape(ctx, charType, isLobby);
        ctx.restore();
    }

    function drawPlayerShape(context, charType, isLobby) {
        if (charType === 'MAN') {
            context.fillStyle = '#000044';
            if(!isLobby && player.jumpY > 5) { context.fillRect(-6,-10,6,8); context.fillRect(2,-14,6,8); }
            else { context.fillRect(-6,-10,5,10); context.fillRect(1,-10,5,10); }

            context.fillStyle = '#fff'; context.fillRect(-8,-24,16,14);
            context.fillStyle = '#f00'; context.fillRect(-1,-24,2,10);
            context.fillStyle = '#ffccaa'; context.fillRect(-7,-34,14,10);
            context.fillStyle = '#000'; context.fillRect(-8,-38,16,6); context.fillRect(-8,-32,4,2); context.fillRect(4,-32,4,2);
            context.fillStyle = '#8b4513'; context.fillRect(6,-20,8,6);
        } 
        else if (charType === 'RABBIT') {
            context.fillStyle = '#fff';
            context.fillRect(-8, -20, 16, 15);
            if(!isLobby && player.jumpY > 5) { context.fillRect(-6,-5,6,5); context.fillRect(2,-8,6,5); }
            else { context.fillRect(-6,-5,5,8); context.fillRect(1,-5,5,8); }
            context.fillRect(-10, -32, 20, 14);
            context.fillStyle = '#ffcccc';
            context.fillRect(-8, -42, 4, 10); context.fillRect(4, -42, 4, 10);
            context.fillStyle = '#000'; context.fillRect(-6,-28,2,2); context.fillRect(4,-28,2,2);
        }
        else if (charType === 'DOG') {
            context.fillStyle = '#d35400';
            context.fillRect(-8, -18, 16, 12);
            if(!isLobby && player.jumpY > 5) { context.fillRect(-6,-6,6,6); context.fillRect(2,-9,6,6); }
            else { context.fillRect(-6,-6,5,8); context.fillRect(1,-6,5,8); }
            context.fillRect(-9, -30, 18, 14);
            context.fillRect(-8, -34, 4, 4); context.fillRect(4, -34, 4, 4);
            context.fillStyle = '#fff'; context.fillRect(-7,-24,14,6);
            context.fillStyle = '#000'; context.fillRect(-2,-22,4,3);
            context.fillRect(-6,-27,2,2); context.fillRect(4,-27,2,2);
        }
    }
    
    // Ï¥àÍ∏∞Ìôî
    loadSavedData();
    resize();
    generateBackgroundObjects();
    updateCharacterPreview();
    updateBackgroundPreview();
</script>
</body>
</html>
